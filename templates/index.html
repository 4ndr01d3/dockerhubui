<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <base target="_blank">
        <title>Biodocker DockerHub Dashboard - DEV</title>
        <link rel="stylesheet" href="/css/style.css"></style>
        <script type="text/javascript" src="/scripts/url.min.js"></script>
        <script type="text/javascript" src="/scripts/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" src="/scripts/jquery.tablesorter.min.js"></script> 
        <script type="text/javascript" src="/scripts/config.js"></script>
        <!-- <script type="text/javascript" src="/scripts/init.js"></script> -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        
          ga('create', 'UA-5291039-12', 'auto');
          ga('send'  , 'pageview');
        </script>

        <script>
            $(document).ready(function(){
                $("#reload").click(
                    function() {
                        $.getJSON( "/update/", function(data){
                            console.log("updated");
                            $("#reload_label").html("reloaded");
                            $("#reload_label").delay(1000).fadeOut('normal', function() {
                                $(this).html('');
                                $(this).fadeIn('fast');
                                var $container = $("#"+CONTAINER);
                                $container.html('');
                                init();
                            });
                        });
                    }
                );
            });

            function show_popup(el) {
                console.log("popping");
                
                var pre = el.getElementsByTagName('pre')[0];
                var val = pre.cloneNode(true);
                val.removeAttribute('class');
                
                console.log(val);

                var $hover = $('#hoverer');
                $hover.addClass('visible');
            
                var $hoverin = $('#hoverer_inner');
                $hoverin.html('');
                $hoverin.append(val);
            }


            function close_popup(){
                var $hover = $('#hoverer');
                $hover.removeClass('visible');
            }

            console.log("initing table sorter");
            $("#repo_table").tablesorter(); 
            console.log("table sorter initialized");
        </script>
    </head>

    <body>
    	<header>Biodocker DockerHub Dashboard - DEV</header>
    		
    	<small>
    		<hr>
    		<a href="https://github.com/sauloal/dockerhubui">Fork DockeHub UI on GitHub</a> ||
    		<a href="https://github.com/sauloal">by Saulo Aflitos - 2015-2015</a> ||
    		<a href="http://biodocker.org/">Biodocker Project on GitHub</a> ||
    		Num Sessions: {{ num_sessions }} || Num Views: {{ num_views }} ||
    		<img id="reload" class="icon" src="/images/reload.svg"></img>
    		<span id="reload_label"></span>
    		<hr>
    	</small>
    	
    	<div id="hoverer" class="popup">
    		<button onclick="close_popup()">Close</button>
    		<div id="hoverer_inner" class="pre_content"></div>
    	</div>
    	

    	<div id="mainContent">
            <h2 class="tableHeader">{{ username|title }}</h2><small>Cache time: {{ cache_time | parse_date }} </small>
            <table id="repo_table_{{username}}" class="repo_table tablesorter">
                <thead>
                    <tr>
                        <th rowspan="2">Repository Name <img src='/images/sort.svg' class='arrows'</image></th>
                        <th class="row_header" colspan="5" >Repository information</th>
                        <th class="row_header" colspan="2" >Build History</th>
                        <th class="row_header" colspan="14">Build Log</th>
                    </tr>

                    <tr>
                        <th name="repo_description">Description <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_is_automated">Is automated <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_star_count"># Stars <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_pull_count"># Pull <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_last_updated">Last updated <img src='/images/sort.svg' class='arrows'</image></th>

                        <th name="repo_info_full_description">Full description <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_count"># Builds <img src='/images/sort.svg' class='arrows'</image></th>

                        <th name="repo_history_last_build_results_source_type">Source type <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_source_url">Source url <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_build_path">Build path <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_source_branch">Source branch <img src='/images/sort.svg' class='arrows'</image></th>

                        <th name="repo_history_last_build_results_status_description">Status Description <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_created_date">Creation date <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_last_updated">Last updated <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_build_code">Build code <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_logs">Logs <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_dockerfile_contents">Dockerfile <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_docker_user">Docker user <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_docker_tag">Docker tag <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_failure">Failure <img src='/images/sort.svg' class='arrows'</image></th>
                        <th name="repo_history_last_build_results_error">Error <img src='/images/sort.svg' class='arrows'</image></th>
                    </th>
                </thead>

                <tbody>
                {% for repo in results %}
                    {% set tr_id="repo_" + repo.namespace + '_' + repo.name | sanitize %}
                    {% set info          = repo.info         %}
                    {% set history       = repo.history      %}
                    {% set builds        = history.results   %}
                    {% set last_build    = builds[0]         %}
                    {% set log           = last_build.log    %}
                    {% set build_results = log.build_results %}


                    <tr class="repository_line" id="{{tr_id}}">
                        <td class="repo_namespace"                                      id="{{tr_id}}_repo_namespace"                                      name="repo_namespace">
                            <a href="{{DOCKERHUB_URL}}u/{{repo.namespace}}/">{{ repo.namespace }}</a> / 
                            <a href="{{DOCKERHUB_URL}}r/{{repo.namespace}}/{{repo.name}}/">{{ repo.name }}
                        </td>
                        <td class="repo_description"                                    id="{{tr_id}}_repo_description"                                    name="repo_description">{{ repo.description }}</td>
                        <td class="repo_is_automated"                                   id="{{tr_id}}_repo_is_automated"                                   name="repo_is_automated">{{ repo.is_automated | automated_colorer | safe }}</td>
                        <td class="repo_star_count"                                     id="{{tr_id}}_repo_star_count"                                     name="repo_star_count">{{ repo.star_count }}</td>
                        <td class="repo_pull_count"                                     id="{{tr_id}}_repo_pull_count"                                     name="repo_pull_count">{{ repo.pull_count }}</td>
                        <td class="repo_last_updated"                                   id="{{tr_id}}_repo_last_updated"                                   name="repo_last_updated">{{ repo.last_updated | parse_date }}</td>
                        <td class="repo_info_full_description"                          id="{{tr_id}}_repo_info_full_description"                          name="repo_info_full_description">
                            <button class="button" onclick="show_popup(this)">Show full description
                                <pre class="pre_data">
                                    {{ info.full_description }}
                                </pre>
                            </button>
                        </td>
                        <td class="history_count"                                       id="{{tr_id}}_history_count"                                       name="repo_history_count">{{ history.count }}</td>

                        {% if build_results.source_type == 'git' %}
                            {% set source_url_url = build_results.source_url.replace('.git', '') %}
                            <td class="repo_history_last_build_results_source_type"         id="{{tr_id}}_repo_history_last_build_results_source_type"         name="repo_history_last_build_results_source_type"><a href="https://github.com">git</a></td>
                            <td class="repo_history_last_build_results_source_url"          id="{{tr_id}}_repo_history_last_build_results_source_url"          name="repo_history_last_build_results_source_url"><a href="{{ source_url_url }}">{{ build_results.source_url.replace("https://github.com", "") }}</a></td>
                            <td class="repo_history_last_build_results_build_path"          id="{{tr_id}}_repo_history_last_build_results_build_path"          name="repo_history_last_build_results_build_path"><a href="{{ source_url_url }}/tree/{{ build_results.source_branch }}{{ build_results.build_path }}">{{ build_results.build_path }}</a></td>
                            <td class="repo_history_last_build_results_source_branch"       id="{{tr_id}}_repo_history_last_build_results_source_branch"       name="repo_history_last_build_results_source_branch"><a href="{{ source_url_url }}/tree/{{ build_results.source_branch }}">{{ build_results.source_branch }}</a></td>
                        {% else %}
                            <td class="repo_history_last_build_results_source_type"         id="{{tr_id}}_repo_history_last_build_results_source_type"         name="repo_history_last_build_results_source_type">{{ build_results.source_type }}</td>
                            <td class="repo_history_last_build_results_source_url"          id="{{tr_id}}_repo_history_last_build_results_source_url"          name="repo_history_last_build_results_source_url">{{ build_results.source_url }}</td>
                            <td class="repo_history_last_build_results_build_path"          id="{{tr_id}}_repo_history_last_build_results_build_path"          name="repo_history_last_build_results_build_path">{{ build_results.build_path }}</td>
                            <td class="repo_history_last_build_results_source_branch"       id="{{tr_id}}_repo_history_last_build_results_source_branch"       name="repo_history_last_build_results_source_branch">{{ build_results.source_branch }}</td>
                        {% endif %}

                        <td class="repo_history_last_build_results_status_description"  id="{{tr_id}}_repo_history_last_build_results_status_description"  name="repo_history_last_build_results_status_description">{{ build_results.status_description | status_colorer | safe }}</td>
                        <td class="repo_history_last_build_created_date"                id="{{tr_id}}_repo_history_last_build_created_date"                name="repo_history_last_build_created_date">{{ last_build.created_date | parse_date }}</td>
                        <td class="repo_history_last_build_last_updated"                id="{{tr_id}}_repo_history_last_build_last_updated"                name="repo_history_last_build_last_updated">{{ last_build.last_updated | parse_date }}</td>
                        <td class="repo_history_last_build_build_code"                  id="{{tr_id}}_repo_history_last_build_build_code"                  name="repo_history_last_build_build_code"><span class="fixed_width"><a href="{{ DOCKERHUB_URL }}r/{{ repo.namespace }}/{{ repo.name }}/builds/{{ last_build.build_code }}/">{{ last_build.build_code }}</a></span></td>
                        
                        <td class="repo_history_last_build_results_logs"                id="{{tr_id}}_repo_history_last_build_results_logs"                name="repo_history_last_build_results_logs">
                            <button class="button" onclick="show_popup(this)">Show logs
                                <pre class="pre_data">
                                    {{ build_results.logs }}
                                </pre>
                            </button>
                        </td>
                        
                        <td class="repo_history_last_build_results_dockerfile_contents" id="{{tr_id}}_repo_history_last_build_results_dockerfile_contents" name="repo_history_last_build_results_dockerfile_contents">
                            <button class="button" onclick="show_popup(this)">Show dockerfile
                                <pre class="pre_data">
                                    {{ build_results.dockerfile_contents }}
                                </pre>
                            </button>
                        </td>

                        <td class="repo_history_last_build_results_docker_user"         id="{{tr_id}}_repo_history_last_build_results_docker_user"         name="repo_history_last_build_results_docker_user">{{ build_results.docker_user }}</td>
                        <td class="repo_history_last_build_results_docker_tag"          id="{{tr_id}}_repo_history_last_build_results_docker_tag"          name="repo_history_last_build_results_docker_tag">{{ build_results.docker_tag }}</td>
                        <td class="repo_history_last_build_results_failure"             id="{{tr_id}}_repo_history_last_build_results_failure"             name="repo_history_last_build_results_failure">{{ build_results.failure }}</td>
                        <td class="repo_history_last_build_results_error"               id="{{tr_id}}_repo_history_last_build_results_error"               name="repo_history_last_build_results_error">{{ build_results.error }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    	</div>
    </body>
</html>
